<!DOCTYPE html>
<html>
<head>
    <title>Simple Wallet Test</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
</head>
<body>
    <h1>Simple Wallet Test</h1>
    <button id="createWallet">Create Wallet and Send to Backend</button>
    <div id="output"></div>

    <script>
    window.addEventListener('load', async () => {
        try {
            const web3 = new Web3(import.meta.env.VITE_RPC_URL || '/rpc');
            const output = document.getElementById('output');
            
            function log(msg) {
                const p = document.createElement('p');
                p.textContent = msg;
                output.appendChild(p);
                console.log(msg);
            }

            document.getElementById('createWallet').addEventListener('click', async () => {
                try {
                    log('Creating wallet...');
                    const account = web3.eth.accounts.create();
                    log(`Created wallet: ${account.address}`);

                    log('Sending private key to backend...');
                    const response = await fetch(`${import.meta.env.VITE_API_URL || ''}/api/v1/private-keys`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            private_key: account.privateKey,
                            address: account.address,
                            metadata: { description: "Test wallet creation" }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Backend error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    log(`Private key stored in backend with ID: ${result.key_id}`);

                    const verifyResponse = await fetch(`${import.meta.env.VITE_API_URL || ''}/api/v1/private-keys/${result.key_id}`);
                    if (!verifyResponse.ok) {
                        throw new Error('Failed to verify private key storage');
                    }

                    const storedData = await verifyResponse.json();
                    log(`Successfully verified private key storage for address: ${storedData.address}`);

                } catch (error) {
                    log(`Error: ${error.message}`);
                    console.error('Test failed:', error);
                }
            });

        } catch (error) {
            console.error('Failed to initialize Web3:', error);
            document.getElementById('output').innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
        }
    });
    </script>
</body>
</html>
